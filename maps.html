<!DOCTYPE html>
<html>
  <head>
    <style>
      #map_canvas {
        width: 600px;
        height: 400px;
      }
      #lower_div{
        position: relative;
        top: 0px;
        right: 0px;
        width: 600px;
        height: 200px;
        background-color: gray;
      }
      #right_div{
        position: absolute;
        top: 0px;
        right: 500px;
        width: 200px;
        height: 600px;
        background-color: gray;
      }
      
    </style>
   
  </head>
  <body bgcolor="gray">
    <div id="map_canvas"></div>
    <div id="lower_div">
        <p id="Marker_Des">Problema</p>
        <button id="Vist"> Visto </button>
        <button id="Comu"> Comunicado </button>
        <button id="Reso"> A Resolver</button>
        <button id="Done"> Resolvido</button>

    </div>
    <div id="right_div"> 
        Latitude: <input type="text" id="_lat"/><br>
        Longitude: <input type="text" id="_lng"/>
        <button id="add_btn">Add marker</button>
        <button id="show_btn">Show markers</button>
        <button id="hide_btn">Hide markers</button>
        <button id="del_btn">Delete markers</button>
        <button id="sav_btn">Save Chances</button>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=places"></script>
    <script>
    var map;
    var markers = [];
    var cont=0;
    var marker_aux;

      function getMarkers(){
        var sperozoneAPI = "http://localhost:8000/sperozoneApp/ocorrencias/";
        $.getJSON("http://localhost:8000/sperozoneApp/ocorrencias/",function(data){
          for (var i = 0; i < data.length; i++) {
            console.log(data[i].title);
            var marker = new google.maps.Marker({
              position: new google.maps.LatLng(parseFloat(data[i].lat), parseFloat(data[i].lon)),
              map: map,
              status: data[i].status,
              description: 'Por Definir',
              title: data[i].title,
              id: i,
              created: false,
              changes: false
            });
            markers.push(marker);

            (function(i) {
              google.maps.event.addListener(markers[i], 'click', function(event)  {
                console.log("CHEGUEI");
                console.log(markers[i].id);
                console.log(markers[i].title);
                $("#Marker_Des").html(markers[i].title);
                marker_aux = markers[i];
              });
            })(i);
          }
        });
      }

      function postMarkers(){
        var seriaMark;

         for (var i = 0; i !== markers.length; i++) {
          console.log(markers[i].created);
          console.log(markers[i].changes);
          if(markers[i].created === true){
            console.log("LOLADA");
            var markerToPost = {
              status: markers[i].status,
              description: 'Por Definir',
              title: markers[i].title,
              report_date: "2014-03-03 15:34:23",
              lat: markers[i].getPosition().lat(),
              lon: markers[i].getPosition().lng()
            };

            seriaMark = JSON.stringify(markerToPost);
            console.log(seriaMark);

            $.post("http://localhost:8000/sperozoneApp/ocorrencias/", seriaMark, function(data) { 
              console.log("Check1");
              for (var i = 0; i < data.length; i++) {
                console.log("Check2");
                console.log(data.status);
              };
            });
          }else{
            if(markers[i].changes === true){
              var markerToPost = {
                status: markers[i].status,
                description: 'Por Definir',
                title: markers[i].title,
                report_date: "2014-03-03 15:34:23",
                lat: markers[i].getPosition().lat(),
                lon: markers[i].getPosition().lng()
              };

              seriaMark = JSON.stringify(markerToPost);

              $.ajax({
                  url: 'http://localhost:8000/sperozoneApp/ocorrencias/'+(i+1),
                  type: 'PUT',
                  data: seriaMark
                  
              });
            }else{

            }
          }
        }
      }

      function initialize() {
        var mapOptions = {
          zoom: 16
        }
        map = new google.maps.Map(document.getElementById('map_canvas'),
            mapOptions);

        // Try HTML5 geolocation
        if(navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            var pos = new google.maps.LatLng(position.coords.latitude,
                                             position.coords.longitude);

            var infowindow = new google.maps.InfoWindow({
              map: map,
              position: pos,
            });

            map.setCenter(pos);
          }, function() {
            handleNoGeolocation(true);
          });
        } else {
          // Browser doesn't support Geolocation
          handleNoGeolocation(false);
        }
        google.maps.event.addListener(map, 'click', function(event)  {
          //console.log("CLICk!");
          placeMarker(event.latLng);
        });
      }

      function handleNoGeolocation(errorFlag) {
        if (errorFlag) {
          var content = 'Error: The Geolocation service failed.';
        } else {
          var content = 'Error: Your browser doesn\'t support geolocation.';
        }

        var options = {
          map: map,
          position: new google.maps.LatLng(60, 105),
          content: content
        };

        var infowindow = new google.maps.InfoWindow(options);
        map.setCenter(options.position);
      }

      function search_place(){
        var input = /** @type {HTMLInputElement} */(
          document.getElementById('pac-input'));
        map.controls[google.maps.ControlPosition.TOP_LEFT].push(input);

        var searchBox = new google.maps.places.SearchBox(
        /** @type {HTMLInputElement} */(input));

      // [START region_getplaces]
      // Listen for the event fired when the user selects an item from the
      // pick list. Retrieve the matching places for that item.
        google.maps.event.addListener(searchBox, 'places_changed', function() {
        var places = searchBox.getPlaces();

          for (var i = 0, marker; marker = markers[i]; i++) {
            marker.setMap(null);
          }

          // For each place, get the icon, place name, and location.
          markers = [];
          var bounds = new google.maps.LatLngBounds();
          for (var i = 0, place; place = places[i]; i++) {
            var image = {
              url: place.icon,
              size: new google.maps.Size(71, 71),
              origin: new google.maps.Point(0, 0),
              anchor: new google.maps.Point(17, 34),
              scaledSize: new google.maps.Size(25, 25)
            };

            bounds.extend(place.geometry.location);
          }

          map.fitBounds(bounds);

          google.maps.event.addListener(map, 'bounds_changed', function() {
            var bounds = map.getBounds();
            searchBox.setBounds(bounds);
          });
        });
      }

      function placeMarker(location){    
        var state = 'Por Resolver';
        if(confirm("Quer Colocar o Problema?")){
          var marker = new google.maps.Marker({
            position: location,
            map: map,
            status: state,
            description: 'To be Defined',
            title: prompt("What's the problem?"),
            id: cont,
            changes: false,
            created: true
          });
          markers.push(marker);
          cont++;
        }else{
          confirm("Ocorrencia cancelada");
        }
        console.log(marker.status);
        google.maps.event.addListener(marker, 'click', function(event)  {
          $("#Marker_Des").html(marker.title);
          marker_aux = marker;
        });
      }

      function addMarker(lat, lng) {
        var marker = new google.maps.Marker({
          position: new google.maps.LatLng(lat, lng),
          zoom: 4,
          mapTypeId: google.maps.MapTypeId.ROADMAP,
          title: 'Por Resolver! '+lat+' e '+lng,
          map:map
        });
        markers.push(marker);
      }

      function setAllMap(map) {
        for (var i = 0; i < markers.length; i++) {
           markers[i].setMap(map);
        }
      }

      function clearMarkers() {
        setAllMap(null);
      }

      function showMarkers() {
        setAllMap(map);
      }

      function deleteMarkers() {
        clearMarkers();
        markers = [];
      }

      function deleteSingleMarkers(id){
        if(confirm("Deseja Reportar como Resolvido e Apagar a Ocurrencia?")){
          for(var i=0; i<markers.length; i++){
            console.log(id+"  "+markers[i].id);
            if(id === markers[i].id){
              markers[i].setMap(null); //delete single marker
              markers.splice(i,1);
              $.ajax({
                  url: 'http://localhost:8000/sperozoneApp/ocorrencias/'+(i+1),
                  type: 'DELETE',
                  success: function(result) {
              
                  }
              });
              break;
            }
          }
        }
      }

      function changeProblemState(marker, estado){
        console.log(marker.status);
        console.log(marker.changes);
        marker.status = estado;
        marker.changes = true;
        console.log(marker.status);
        console.log(marker.changes);
      }

      $(document).ready(function(){
        initialize();
        getMarkers();
        //search_place();

        $("#add_btn").click(function() {
            var lat = $("#_lat").val();
            var lng = $("#_lng").val();
            addMarker(lat,lng);
        });
        $("#show_btn").click(function(){
          showMarkers();
        });
        $("#hide_btn").click(function(){
          clearMarkers();
        });
        $("#del_btn").click(function(){
          deleteMarkers();
        });

        $("#Vist").click(function(){
          var str = 'Visto';
          changeProblemState(marker_aux, str);
        });
        $("#Comu").click(function(){
          var str = 'Comunicado';
          changeProblemState(marker_aux, str);
        });
        $("#Reso").click(function(){
          var str = 'A Resolver';
          changeProblemState(marker_aux, str);
        });
        $("#Done").click(function(){
          console.log(marker_aux.id);
          deleteSingleMarkers(marker_aux.id);
        });
        $("#sav_btn").click(function(){
          postMarkers();
        });  
      });
    </script>
  </body>
</html>